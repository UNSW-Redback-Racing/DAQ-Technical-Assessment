# Firmware TA

### Key Concepts
* Controller Area Network (CAN)
* Can Frames
* Can Bus
* What is a DBC file?


### CAN & CANBUS

#### CAN Basics
Similar to HTTP, USB or other communication methods over wires, CAN is a communication standard that works to asyncronously connect the sensors of a vehicle to each other and a central computer (ECU).

CAN is used in various applications such as automotive vehicles, farming machinery and even some aviation applications due to the robustness of the standard.

##### Key points
* All types of CAN frames have a 64 bit payload, although not all 64 bits have to be used
* Each CAN frame is split into signals
* Can Frames are defined by a DBC file
* A CAN Bus is a network in which CAN data is sent through.
* There are two main types of CAN. CAN and CAN FD. CAN will only have a 11 bit CAN ID where as CAN FD can support up to a 29 bit CAN ID. The diagram below shows the frame breakdown of a CAN frame.

![can_frame_breakdown](./can_frame_breakdown.svg)

Below is the breakdown of a CAN FD frame.
![can_fd_frame_breakdown](./can_fd_frame_breakdown.png)

### DBC

#### What is it?

A DBC file is a text file which defines how a CAN frame can be broken down into one or multiple signals. 

This is an example of one


For example:
- SensorA starts at bit `0` of the 64 bit data sequence and has a length of 16 bits.
- SensorB starts at bit `16` of the 64 bit data sequence and has a length of 16 bits.
- SensorC starts at bit `32` of the 64 bit data sequence and has a length of 16 bits.
- SensorD starts at bit `32` of the 64 bit data sequence and has a length of 16 bits.
```
 BO_ 1697 Example_Sensors: 8 Vector__XXX
 SG_ SensorD : 48|16@1- (0.1,0) [0|0] "Degrees Celsius" Vector__XXX
 SG_ SensorC : 32|16@1- (0.1,0) [0|0] "Degrees Celsius" Vector__XXX
 SG_ SensorB : 16|16@1- (0.1,0) [0|0] "Degrees Celsius" Vector__XXX
 SG_ SensorA : 0|16@1- (0.1,0) [0|0] "Degrees Celsius" Vector__XXX
```

These sensor definitions allows the raw CAN data to be interpreted into human friendly values by masking out the correct sequence of bits.

![dbc_breakdown](./dbc_breakdown.png)

As shown in the above diagram, it's worth noting that:

- Generally, each CAN Frame is defined by `BO`
  - Each signal within that CAN frame is listed under the CAN frame prefixed with `SG_`
- The CAN Frame ID is defined in decimal as `2364540158` and is unique within the DBC file.
  - This CAN Frame holds 1 sensor `EngineSpeed` which starts at bit 24 of the 64 bit data payload and has a length of 16 bits.
- `@1` indicates that these bits are of little endianess and the `+` indicates it is unsigned.
  - Conversely, `@0` would indicate big endianess and a `-` would indicates it is signed.
- The scale is a multiplier applied to the decimal interpretation of the masked bits to acquire the correct sensor value.
- `0|8031.875` is metadata used to indicate the valid range for this sensor
- `rpm` is metadata used to indicate the valid unit for this sensor

## Resources

### CAN/DBC

- https://www.csselectronics.com/pages/can-dbc-file-database-intro

## Tasks
You are provided with two files.

- `dump.log`
  - This file is a 'CAN dump' of data from our car. It is generated by the `candump` bash command on linux can-utils.
- `SensorBus.dbc`
  - This file defines the CAN definitions for the can log file above. It is a cutdown version of the one used on the Redback car with only one CAN frame defined. `ECU_WheelSpeed`.


### Stage 1
Given the definitions in `SensorBus.dbc`, parse the dump.log file to extract the `WheelSpeedFR` value and `WheelSpeedRR` values.
Then append a timestamp to match the output in the expectedOutput.log

* A C++ implementation is highly preferrable however you may use other languages
* You are allowed to use libraries to aid your implementation or implement your own method to parse
 


### Stage 2 
Answer theorhetical questions about CAN hardware and Software in `answer.txt`.

1. What are advantages and disadvantages of CAN over other protocols such as USB, PCIE, SPI etc? List reasons of why Redback Racing's Embedded Systems, Powertrain, DAQ and Autonomous Vehicles(AV) departments would use CAN?
Hint: CAN is versatile.